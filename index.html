
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trials Crowd Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.08)' } } }
    };
  </script>
  <style>
    .fade { transition: opacity 200ms ease, transform 200ms ease; }
    .btn { border-radius: 1rem; padding: 0.5rem 0.75rem; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .btn-ghost { background: white; color: #111827; border: 1px solid #e5e7eb; }
    .btn-primary { background: #4f46e5; color: white; }
    .btn-danger { background: #e11d48; color: white; }
    .btn-success { background: #059669; color: white; }
    .chip { display: inline-flex; align-items: center; border-radius: 9999px; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 700; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100">
  <header class="sticky top-0 z-40 backdrop-blur bg-white/90 dark:bg-gray-900/80 border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="text-indigo-600">
          <path d="M12 3l3.09 6.26L22 10.27l-5 4.87L18.18 22 12 18.9 5.82 22 7 15.14l-5-4.87 6.91-1.01L12 3z"></path>
        </svg>
        <h1 class="text-lg font-semibold">Trials Crowd Report</h1>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <button id="themeToggle" class="btn btn-ghost hidden sm:inline-flex">Toggle theme</button>

        <div id="authedArea" class="hidden items-center gap-3">
          <span id="userName" class="text-sm text-gray-700 dark:text-gray-300"></span>
          <img id="userAvatar" class="w-8 h-8 rounded-full border border-gray-200 dark:border-gray-700" alt="avatar" />
          <button id="signOutBtn" class="btn btn-ghost">Sign out</button>
        </div>

        <div id="loginArea" class="flex items-center gap-2">
          <button id="loginTwitter" class="btn btn-primary">Sign in with X</button>
          <button id="loginGithub" class="btn btn-ghost">GitHub</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex flex-wrap gap-2 mb-6">
      <button class="tabBtn btn btn-ghost" data-tab="submit">Submit report</button>
      <button class="tabBtn btn btn-ghost" data-tab="browse">Browse & vote</button>
      <button class="tabBtn btn btn-ghost" data-tab="mine">My votes</button>
      <button class="tabBtn btn btn-ghost" data-tab="weekly">Weekly leaderboard</button>
      <a class="ml-auto text-sm text-indigo-600 hover:underline" href="terms.html">Terms & Privacy</a>
    </div>

    <section id="tab-submit" class="tabPanel hidden fade">
      <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-5">
        <h2 class="text-base font-semibold mb-3">Submit a Trials Report link</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Paste a <span class="font-mono">trials.report</span> player or match link. Optionally add a label for who/what this report is about (e.g., Bungie name).
        </p>
        <div class="flex flex-col sm:flex-row gap-3">
          <input id="reportUrl" type="url" placeholder="https://trials.report/guardian/… or https://trials.report/report/…" class="w-full rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 px-3 py-2" />
          <input id="playerLabel" type="text" placeholder="Optional: Player label (e.g., BungieName#1234)" class="w-full sm:w-72 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 px-3 py-2" />
          <button id="submitReportBtn" class="btn btn-primary">Add report</button>
        </div>
        <p id="submitHelp" class="mt-3 text-xs text-gray-500"></p>
      </div>
    </section>

    <section id="tab-browse" class="tabPanel hidden fade">
      <div class="mb-3 flex items-center gap-2">
        <input id="searchInput" type="text" placeholder="Search by label or URL…" class="w-full sm:w-96 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-950 px-3 py-2" />
        <button id="refreshBrowse" class="btn btn-ghost">Refresh</button>
      </div>
      <div id="browseList" class="grid gap-3"></div>
      <div id="browseEmpty" class="hidden text-sm text-gray-500 mt-4">No reports yet.</div>
    </section>

    <section id="tab-mine" class="tabPanel hidden fade">
      <div id="mineList" class="grid gap-3"></div>
      <div id="mineEmpty" class="hidden text-sm text-gray-500">No votes yet. Go vote on the Browse tab.</div>
    </section>

    <section id="tab-weekly" class="tabPanel hidden fade">
      <div class="text-sm text-gray-600 dark:text-gray-400 mb-3">Top reports by net votes in the last 7 days.</div>
      <div id="weeklyList" class="grid gap-3"></div>
      <div id="weeklyEmpty" class="hidden text-sm text-gray-500">Nothing to show yet.</div>
    </section>

    <div id="toast" class="fixed bottom-4 inset-x-0 mx-auto w-fit px-4 py-2 rounded-xl bg-gray-900 text-white text-sm shadow-soft opacity-0 pointer-events-none"></div>
  </main>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';


    // =========================
    // CONFIG — REPLACE ME
    // =========================
    const SUPABASE_URL = 'https://ygbmgwzgascfiflaefwj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnYm1nd3pnYXNjZmlmbGFlZndqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MTg5NDcsImV4cCI6MjA3MDI5NDk0N30.q0PxznHk83tXnaDZYbYQmlumGOk6TtPsXZG0jB0iweY';


    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        flowType: 'pkce',
        detectSessionInUrl: true,
        autoRefreshToken: true,
      }
    });
    // expose for quick console testing
    window.sb = supabase;

    // UI helpers
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const toast = (msg, ok=true) => {
      const t = $('#toast');
      t.textContent = msg;
      t.classList.remove('opacity-0');
      t.style.background = ok ? '#111827' : '#7f1d1d';
      setTimeout(() => t.classList.add('opacity-0'), 2000);
    };

    // Theme
    const themePref = localStorage.getItem('theme') || 'system';
    const applyTheme = () => {
      const isDark = themePref === 'dark' || (themePref === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.documentElement.classList.toggle('dark', isDark);
    };
    applyTheme();
    $('#themeToggle').addEventListener('click', () => {
      const cur = localStorage.getItem('theme') || 'system';
      const next = cur === 'dark' ? 'light' : cur === 'light' ? 'system' : 'dark';
      localStorage.setItem('theme', next); applyTheme();
    });

    // Tabs
    const showTab = (name) => {
      $$('.tabPanel').forEach(el => el.classList.add('hidden'));
      $(`#tab-${name}`).classList.remove('hidden');
    };
    $$('.tabBtn').forEach(b => b.addEventListener('click', () => showTab(b.dataset.tab)));
    showTab('browse');

    // Auth state
    let currentUser = null;

    async function refreshProfileUI() {
      if (!currentUser) {
        $('#loginArea').classList.remove('hidden');
        $('#authedArea').classList.add('hidden');
        return;
      }
      $('#loginArea').classList.add('hidden');
      $('#authedArea').classList.remove('hidden');
      const n = currentUser.user_metadata?.user_name || currentUser.user_metadata?.name || currentUser.email || currentUser.id;
      $('#userName').textContent = n;
      const avatar = currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture || 'https://api.dicebear.com/9.x/pixel-art/svg?seed=' + currentUser.id;
      $('#userAvatar').src = avatar;
      await upsertOwnProfile();
    }

    async function upsertOwnProfile() {
      const u = currentUser; if (!u) return;
      const { error } = await supabase.from('profiles').upsert({
        id: u.id,
        username: u.user_metadata?.user_name || u.user_metadata?.name || null,
        avatar_url: u.user_metadata?.avatar_url || u.user_metadata?.picture || null,
      });
      if (error) console.warn('profile upsert error', error);
    }

    // OAuth buttons
    $('#loginTwitter').addEventListener('click', async () => {
      const { error } = await supabase.auth.signInWithOAuth({ provider: 'twitter', options: { redirectTo: window.location.href } });
      if (error) toast('Login failed (X/Twitter): ' + error.message, false);
    });
    $('#loginGithub').addEventListener('click', async () => {
      const { error } = await supabase.auth.signInWithOAuth({ provider: 'github', options: { redirectTo: window.location.href } });
      if (error) toast('Login failed (GitHub): ' + error.message, false);
    });
    $('#signOutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      currentUser = null; await refreshProfileUI();
    });

    supabase.auth.onAuthStateChange(async (_event, session) => {
      currentUser = session?.user || null;
      await refreshProfileUI();
      await Promise.all([loadBrowse(), loadMine(), loadWeekly()]);
    });

    const { data: sessionData } = await supabase.auth.getSession();
    currentUser = sessionData.session?.user || null;
    await refreshProfileUI();

    // ===== Submit report =====
    function normalizeTrialsUrl(raw) {
      if (!raw) return null;
      let s = String(raw).trim();
      if (!/^https?:\/\//i.test(s)) s = 'https://' + s; // allow bare trials.report
      try {
        const u = new URL(s);
        if (!u.hostname.endsWith('trials.report')) return null;
        return u.toString();
      } catch { return null; }
    }

    $('#submitReportBtn').addEventListener('click', async () => {
      const help = $('#submitHelp');
      help.textContent = '';

      if (!currentUser) { toast('Please sign in to submit.', false); return; }

      const btn = $('#submitReportBtn');
      const url = normalizeTrialsUrl($('#reportUrl').value);
      const label = ($('#playerLabel').value || '').trim() || null;

      if (!url) {
        help.textContent = 'Enter a valid trials.report URL (include https://)';
        help.className = 'mt-3 text-xs text-rose-600';
        return;
      }

      btn.disabled = true; btn.textContent = 'Adding…';
      try {
        // submitter_id is set server-side by trigger
        const { error } = await supabase.from('reports').insert({
          trials_url: url,
          player_label: label,
        });

        if (error) {
          console.error('Insert error', error);
          const msg = /unique/i.test(error.message) ? 'That link was already submitted.' : error.message;
          help.textContent = msg; help.className = 'mt-3 text-xs text-rose-600';
          toast('Could not add report', false);
        } else {
          $('#reportUrl').value = ''; $('#playerLabel').value = '';
          help.textContent = 'Report added.'; help.className = 'mt-3 text-xs text-emerald-600';
          toast('Report added');
          await loadBrowse();
          showTab('browse');
        }
      } finally {
        btn.disabled = false; btn.textContent = 'Add report';
      }
    });

    // ===== Browse & vote =====
    $('#refreshBrowse').addEventListener('click', () => loadBrowse());
    $('#searchInput').addEventListener('input', () => renderBrowse(window.__reportStatsCache || []));

    async function loadBrowse() {
      const { data, error } = await supabase
        .from('report_stats')
        .select('*')
        .order('net', { ascending: false })
        .limit(200);
      if (error) { console.warn(error); toast('Failed to load reports', false); return; }
      window.__reportStatsCache = data || [];
      await renderBrowse(data || []);
    }

    async function getMyVotesFor(reportIds) {
      if (!currentUser || reportIds.length === 0) return {};
      const { data, error } = await supabase
        .from('votes')
        .select('report_id, vote')
        .eq('voter_id', currentUser.id)
        .in('report_id', reportIds);
      if (error) return {};
      const map = {}; for (const v of data) map[v.report_id] = v.vote; return map;
    }

    async function renderBrowse(rows) {
      const q = $('#searchInput').value.trim().toLowerCase();
      const filtered = rows.filter(r =>
        !q ||
        (r.player_label || '').toLowerCase().includes(q) ||
        (r.trials_url || '').toLowerCase().includes(q)
      );
      const container = $('#browseList'); container.innerHTML = '';
      $('#browseEmpty').classList.toggle('hidden', filtered.length > 0);
      const idList = filtered.map(r => r.report_id);
      const myVotes = await getMyVotesFor(idList);

      for (const r of filtered) {
        const el = document.createElement('div');
        el.className = 'bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-4 flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between';
        const legit = Number(r.legit_votes || 0);
        const cheat = Number(r.cheat_votes || 0);
        const net = Number(r.net || (cheat - legit));
        const my = myVotes[r.report_id] || null;
        el.innerHTML = `
          <div class="min-w-0">
            <div class="flex items-center gap-2">
              <a href="${r.trials_url}" target="_blank" class="font-medium truncate hover:underline">${r.player_label || r.trials_url}</a>
              <span class="chip bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300">ID ${r.report_id}</span>
            </div>
            <div class="mt-1 text-xs text-gray-500">Added ${new Date(r.created_at).toLocaleString()}</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="chip bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300">Legit ${legit}</span>
            <span class="chip bg-rose-100 dark:bg-rose-900/40 text-rose-700 dark:text-rose-300">Cheat ${cheat}</span>
            <span class="chip bg-indigo-100 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300">Net ${net}</span>
            <div class="w-px h-6 bg-gray-200 dark:bg-gray-700 mx-1"></div>
            <button data-vote="legit" data-id="${r.report_id}" class="btn ${my==='legit' ? 'btn-success' : 'btn-ghost'}">Legit</button>
            <button data-vote="cheat" data-id="${r.report_id}" class="btn ${my==='cheat' ? 'btn-danger' : 'btn-ghost'}">Cheat</button>
          </div>
        `;
        container.appendChild(el);
      }

      // vote handlers
      container.querySelectorAll('button[data-vote]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!currentUser) { toast('Sign in to vote.', false); return; }
          const vote = btn.dataset.vote; const reportId = Number(btn.dataset.id);
          const { error } = await supabase.from('votes').upsert({
            report_id: reportId,
            voter_id: currentUser.id,
            vote,
          }, { onConflict: 'report_id,voter_id' });
          if (error) { toast(error.message, false); return; }
          toast('Vote recorded');
          await loadBrowse(); await loadMine(); await loadWeekly();
        });
      });
    }

    // ===== My votes =====
    async function loadMine() {
      if (!currentUser) { $('#mineList').innerHTML = ''; $('#mineEmpty').classList.remove('hidden'); return; }
      const { data, error } = await supabase
        .from('votes')
        .select('report_id, vote, created_at, reports!inner(player_label, trials_url)')
        .eq('voter_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(200);
      if (error) { console.warn(error); return; }
      const container = $('#mineList'); container.innerHTML = '';
      $('#mineEmpty').classList.toggle('hidden', (data||[]).length > 0);
      for (const v of (data || [])) {
        const el = document.createElement('div');
        el.className = 'bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-4 flex items-center justify-between';
        el.innerHTML = `
          <div class="min-w-0">
            <a class="font-medium hover:underline truncate" href="${v.reports.trials_url}" target="_blank">${v.reports.player_label || v.reports.trials_url}</a>
            <div class="text-xs text-gray-500 mt-1">Voted <b>${v.vote}</b> on ${new Date(v.created_at).toLocaleString()}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-ghost text-xs" data-change="legit" data-id="${v.report_id}">Set Legit</button>
            <button class="btn btn-ghost text-xs" data-change="cheat" data-id="${v.report_id}">Set Cheat</button>
            <button class="btn btn-ghost text-xs" data-remove data-id="${v.report_id}">Remove</button>
          </div>
        `;
        container.appendChild(el);
      }
      container.querySelectorAll('button[data-change]').forEach(b => b.addEventListener('click', async () => {
        const reportId = Number(b.dataset.id);
        const vote = b.dataset.change;
        const { error } = await supabase.from('votes').upsert({ report_id: reportId, voter_id: currentUser.id, vote }, { onConflict: 'report_id,voter_id' });
        if (error) return toast(error.message, false);
        toast('Vote updated'); await loadBrowse(); await loadMine(); await loadWeekly();
      }));
      container.querySelectorAll('button[data-remove]').forEach(b => b.addEventListener('click', async () => {
        const reportId = Number(b.dataset.id);
        const { error } = await supabase.from('votes').delete().match({ report_id: reportId, voter_id: currentUser.id });
        if (error) return toast(error.message, false);
        toast('Vote removed'); await loadBrowse(); await loadMine(); await loadWeekly();
      }));
    }

    // ===== Weekly leaderboard =====
    async function loadWeekly() {
      const { data, error } = await supabase
        .from('weekly_cheater_leaderboard')
        .select('*')
        .order('net', { ascending: false })
        .limit(50);
      if (error) { console.warn(error); return; }
      const container = $('#weeklyList'); container.innerHTML = '';
      $('#weeklyEmpty').classList.toggle('hidden', (data||[]).length > 0);
      for (const r of (data || [])) {
        const el = document.createElement('div');
        el.className = 'bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-4 flex items-center justify-between';
        const legit = Number(r.legit_votes || 0);
        const cheat = Number(r.cheat_votes || 0);
        const net = Number(r.net || (cheat - legit));
        el.innerHTML = `
          <div class="min-w-0">
            <a class="font-medium hover:underline truncate" href="${r.trials_url}" target="_blank">${r.player_label || r.trials_url}</a>
            <div class="text-xs text-gray-500 mt-1">Cheat ${cheat} • Legit ${legit} • Net ${net}</div>
          </div>
          <a href="${r.trials_url}" target="_blank" class="btn btn-ghost">Open</a>
        `;
        container.appendChild(el);
      }
    }

    // Initial data
    await Promise.all([loadBrowse(), loadWeekly(), loadMine()]);
  </script>
</body>
</html>
